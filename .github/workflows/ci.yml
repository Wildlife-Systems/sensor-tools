name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Add WildlifeSystems apt repository
      run: |
        sudo wget -O /usr/share/keyrings/ws.gpg https://wildlife.systems/ws.gpg
        echo -e "Types: deb\nURIs: https://apt.wildlife.systems\nSuites: stable\nComponents: main\nArchitectures: all amd64\nSigned-By: /usr/share/keyrings/ws.gpg" | sudo tee /etc/apt/sources.list.d/ws.sources > /dev/null
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential g++ sensor-control
    
    - name: Build with coverage
      run: make clean all COVERAGE=1
    
    - name: Run unit tests
      run: make test COVERAGE=1
    
    - name: Run integration tests
      run: make test-integration
    
    - name: Generate coverage report
      run: make coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false
        verbose: true

  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential debhelper devscripts fakeroot lintian
    
    - name: Build Debian package
      run: |
        dpkg-buildpackage -us -uc -b
    
    - name: Run lintian checks
      run: |
        lintian --info --display-info ../sensor-tools_*.deb || true
    
    - name: Upload .deb artifact
      uses: actions/upload-artifact@v4
      with:
        name: debian-package
        path: ../sensor-tools_*.deb
        retention-days: 14
